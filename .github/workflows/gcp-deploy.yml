name: Build and Deploy to Google Cloud Run

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build images and deploy to Cloud Run
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if GCP secrets are configured
        id: check_secrets
        run: |
          if [ -z "${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}" ] || [ -z "${{ secrets.GCP_SA }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "⚠️ GCP secrets not configured. Skipping deployment."
            echo "To enable deployment, configure the required secrets in repository settings."
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "✅ GCP secrets configured. Proceeding with deployment."
          fi

      # Authenticate to GCP using Workload Identity Federation (no service account keys stored in repo)
      - name: Authenticate to Google Cloud
        if: steps.check_secrets.outputs.configured == 'true'
        uses: google-github-actions/auth@v1
        with:
          # Set this repo secret to the full provider resource string, e.g.
          # projects/123456789/locations/global/workloadIdentityPools/pool/providers/provider
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          # Set this repo secret to the service account email the GitHub Action should impersonate
          service_account: ${{ secrets.GCP_SA }}

      - name: Setup gcloud CLI
        if: steps.check_secrets.outputs.configured == 'true'
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          export_default_credentials: true

      - name: Configure Docker for Artifact Registry
        if: steps.check_secrets.outputs.configured == 'true'
        run: |
          REGION=${{ secrets.GCP_REGION }}
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - id: build_backend
        name: Build & push backend image
        if: steps.check_secrets.outputs.configured == 'true'
        env:
          PROJECT: ${{ secrets.GCP_PROJECT }}
          REGION: ${{ secrets.GCP_REGION }}
          ARTIFACT_REPO: ${{ secrets.ARTIFACT_REGISTRY_REPO }}
        run: |
          SHORT_SHA=${GITHUB_SHA:0:7}
          IMAGE_BACKEND="${REGION}-docker.pkg.dev/${PROJECT}/${ARTIFACT_REPO}/backend:${SHORT_SHA}"
          echo "Building backend image: ${IMAGE_BACKEND}"
          gcloud builds submit --tag "${IMAGE_BACKEND}" -f backend/Dockerfile .
          echo "image=${IMAGE_BACKEND}" >> $GITHUB_OUTPUT

      - id: build_frontend
        name: Build & push frontend image
        if: steps.check_secrets.outputs.configured == 'true'
        env:
          PROJECT: ${{ secrets.GCP_PROJECT }}
          REGION: ${{ secrets.GCP_REGION }}
          ARTIFACT_REPO: ${{ secrets.ARTIFACT_REGISTRY_REPO }}
        run: |
          SHORT_SHA=${GITHUB_SHA:0:7}
          IMAGE_FRONTEND="${REGION}-docker.pkg.dev/${PROJECT}/${ARTIFACT_REPO}/frontend:${SHORT_SHA}"
          echo "Building frontend image: ${IMAGE_FRONTEND}"
          # Build from repo root but use the frontend/Dockerfile (it expects package.json in context)
          gcloud builds submit --tag "${IMAGE_FRONTEND}" -f frontend/Dockerfile .
          echo "image=${IMAGE_FRONTEND}" >> $GITHUB_OUTPUT

      - name: Deploy backend to Cloud Run
        if: steps.check_secrets.outputs.configured == 'true'
        env:
          IMAGE_BACKEND: ${{ steps.build_backend.outputs.image }}
          REGION: ${{ secrets.GCP_REGION }}
        run: |
          IMAGE=${IMAGE_BACKEND}
          echo "Deploying backend using image: ${IMAGE}"
          gcloud run deploy backend-service \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --service-account ${{ secrets.CLOUD_RUN_SA }}

      - name: Deploy frontend to Cloud Run
        if: steps.check_secrets.outputs.configured == 'true'
        env:
          IMAGE_FRONTEND: ${{ steps.build_frontend.outputs.image }}
          REGION: ${{ secrets.GCP_REGION }}
        run: |
          IMAGE=${IMAGE_FRONTEND}
          echo "Deploying frontend using image: ${IMAGE}"
          gcloud run deploy frontend-service \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --service-account ${{ secrets.CLOUD_RUN_SA }}

      - name: Output deploy URLs
        if: steps.check_secrets.outputs.configured == 'true'
        run: |
          echo "Backend URL: $(gcloud run services describe backend-service --region ${{ secrets.GCP_REGION }} --platform managed --format='value(status.url)')"
          echo "Frontend URL: $(gcloud run services describe frontend-service --region ${{ secrets.GCP_REGION }} --platform managed --format='value(status.url)')"
